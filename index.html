<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philippine Senatorial Candidates 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f3f4f6; /* Light text */
        }
        .candidate-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden; /* Ensures image corners are rounded with the card */
            position: relative; /* Required for absolute positioning of the hover button */
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 2px #4f46e5; /* Indigo focus ring on hover */
        }
        .candidate-card.selected {
            box-shadow: 0 0 0 3px #3b82f6; /* Blue ring for selected */
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay for modal */
        }
        .modal-content {
            background-color: #1f2937; /* Darker modal content bg */
            color: #d1d5db; /* Lighter text for modal content */
            max-height: 90vh;
            overflow-y: auto;
        }
        .tab-button {
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .tab-button.active {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }
        .tab-button:not(.active):hover {
            background-color: #374151; /* Gray-700 for hover on inactive tabs */
        }
        .action-button {
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            opacity: 0.9;
        }
        .search-input {
            background-color: #374151; /* Gray-700 */
            border-color: #4b5563; /* Gray-600 */
            color: #f3f4f6; /* Light text */
        }
        .search-input::placeholder {
            color: #9ca3af; /* Gray-400 */
        }
        /* Custom scrollbar for modal content (optional) */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #374151; /* Gray-700 */
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #4f46e5; /* Indigo */
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* Lighter Indigo */
        }
        .section-title {
            border-bottom: 1px solid #4b5563; /* Gray-600 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #9ca3af; /* Gray-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .detail-item {
            margin-bottom: 0.75rem;
        }
        .detail-item strong {
            color: #e5e7eb; /* Gray-200 */
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000; /* Ensure it's above other content */
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.error {
            background-color: #ef4444; /* Red-500 */
        }
         .notification.success {
            background-color: #22c55e; /* Green-500 */
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes shine {
            0% {
                background-position: -200%;
            }
            100% {
                background-position: 200%;
            }
        }

        .shining-text {
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0.2) 100%);
            background-size: 200%;
            animation: shine 2s infinite;
        }
        .search-suggestions {
            position: absolute;
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #374151; /* Gray-700 */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 50; /* Ensure it's above candidate grid but below modals */
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item:hover {
            background-color: #374151; /* Gray-700 */
        }
    </style>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "rgxl0spdx0");
    </script>
    <script>
        async function fetchCandidates() {
            try {
                const response = await fetch('candidates.json');
                if (!response.ok) throw new Error('Failed to fetch candidates data');
                return await response.json();
            } catch (error) {
                console.error('Error fetching candidates:', error);
                return [];
            }
        }
    </script>
</head>
<body class="min-h-screen">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-red-500 to-yellow-500 shining-text">
                Philippine Senatorial Candidates
            </h1>
            <p class="text-lg text-gray-400 mt-2">May 2025 National Elections</p>
            <p class="text-sm text-gray-500 mt-1">Click on a candidate to view details. You can select up to 12 preferred senators.</p>
        </header>

        <div id="apiKeySection" class="mb-6 p-4 bg-gray-800 rounded-lg shadow">
            <div class="flex items-center mb-3">
                <label for="aiSearchToggle" class="text-sm font-medium text-gray-300 mr-3">Enable AI Search:</label>
                <input type="checkbox" id="aiSearchToggle" class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                <span id="aiSearchInfo" class="ml-2 text-xs text-gray-400">
                    AI features are active. Uses Google Gemini.
                </span>
                
            </div>
            <div id="apiKeyControlsContainer" class="hidden"> {/* This container will be effectively hidden by default now */}
                <p id="apiKeyStatusMessage" class="text-sm text-gray-400 mb-2"></p>
                {/* API Key input elements are no longer needed for the user if pre-configured */}
            </div>
        </div>


        <div class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex space-x-2 border border-gray-700 rounded-lg p-1 bg-gray-800">
                <button id="allCandidatesTab" class="tab-button active px-4 py-2 rounded-md text-sm font-medium">All Candidates</button>
                <button id="mySenatorsTab" class="tab-button px-4 py-2 rounded-md text-sm font-medium">My Senators (<span id="selectedCount">0</span>/12)</button>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:flex-grow relative"> 
                <div class="relative w-full sm:flex-grow">
                    <input type="text" id="searchInput" placeholder="Search candidates..." class="search-input w-full pl-10 pr-4 py-2 rounded-lg border focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div id="searchSuggestionsContainer" class="search-suggestions w-full hidden">
                        {/* Suggestions will be populated here by JavaScript */}
                    </div>
                </div>
                <button id="aiMySenatorsInsightsButton" title="Select 'My Senators' tab and pick candidates" class="w-full sm:w-auto action-button bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Slate Insights
                </button>
                <button id="shareSlateButton" title="Select 'My Senators' tab and pick candidates to share" class="w-full sm:w-auto action-button bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Share Slate
                </button>
            </div>
        </div>

        <div id="candidateGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            </div>
        <p id="noResultsMessage" class="text-center text-gray-400 mt-10 text-xl hidden">No candidates found.</p>
        <p id="noSelectionsMessage" class="text-center text-gray-400 mt-10 text-xl hidden">You have not selected any preferred senators yet.</p>

    </div>

    <div id="candidateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-3xl rounded-lg shadow-xl p-6 md:p-8">
            <div class="flex justify-between items-start mb-6">
                <h2 id="modalCandidateNameTitle" class="text-3xl font-bold text-white">Candidate Name</h2>
                <button id="closeModalButton" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="md:flex md:space-x-6">
                <div class="md:w-1/3 text-center md:text-left mb-6 md:mb-0">
                    <img id="modalCandidatePhoto" src="" alt="Candidate Photo" class="w-48 h-48 object-cover rounded-lg mx-auto md:mx-0 mb-4 border-2 border-gray-600">
                    <h3 id="modalCandidateParty" class="text-indigo-400"></h3>
                    <p id="modalCandidateAge" class="text-sm text-gray-400"></p>
                    <p id="modalCandidateResidence" class="text-sm text-gray-400"></p>
                    <button id="modalSelectButton" class="w-full action-button text-white font-semibold py-3 px-4 rounded-lg mt-4">
                        Add to My Senators
                    </button>
                    <a id="modalProfileLink" href="#" target="_blank" class="w-full block text-center action-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg mt-4">
                        View Profile
                    </a>
                    <div class="flex justify-between mt-4">
                        <button id="prevCandidateButton" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                            Previous
                        </button>
                        <button id="nextCandidateButton" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                            Next
                        </button>
                    </div>
                    <div id="aiInsightsSection" class="mt-4 pt-4 border-t border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-3">AI Insights (Experimental):</h5>
                        <div class="space-y-2 mb-3">
                            <button id="aiSummarizeDetailsButton" class="w-full action-button bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-3 rounded-lg text-sm disabled:opacity-50">
                                Summarize Details
                            </button>
                            <button id="aiCheckIssuesButton" class="w-full action-button bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-3 rounded-lg text-sm disabled:opacity-50">
                                Check Public Issues
                            </button>
                            <button id="aiSummarizeContributionsButton" class="w-full action-button bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm disabled:opacity-50">
                                Contributions
                            </button>
                        </div>
                        <div id="aiModalOutput" class="p-3 bg-gray-700 rounded-md text-sm text-gray-300 min-h-[60px] whitespace-pre-wrap" style="display: none;">
                            <!-- AI output will appear here -->
                        </div>
                    </div>
                </div>

                <div class="md:w-2/3">
                    <div class="mb-6">
                        <h4 class="section-title">Education</h4>
                        <ul id="modalEducation" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Job Affiliations</h4>
                        <ul id="modalJobAffiliations" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Government Experience</h4>
                        <ul id="modalGovtExperience" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Platforms</h4>
                        <ul id="modalPlatforms" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">In Favor Of</h4>
                        <ul id="modalInFavor" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Against</h4>
                        <ul id="modalAgainst" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Family Members in Politics</h4>
                        <ul id="modalFamilyMembers" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Laws Passed</h4>
                        <ul id="modalLawsPassed" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Senators Insights Modal -->
    <div id="mySenatorsInsightsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-2xl rounded-lg shadow-xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">AI Insights for Your Selected Senators</h2>
                <button id="closeMySenatorsInsightsModalButton" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="mySenatorsInsightsOutput" class="p-4 bg-gray-700 rounded-md text-sm text-gray-300 min-h-[200px] max-h-[60vh] overflow-y-auto whitespace-pre-wrap">
                <!-- AI output will appear here -->
            </div>
            <div class="mt-6 text-right">
                <button id="closeMySenatorsInsightsModalButtonBottom" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Share Slate Modal -->
    <div id="shareSlateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-md rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Share Your Senatorial Slate</h2>
                <button id="closeShareSlateModalButton" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-300 mb-1">Copy link:</p>
            <div class="flex mb-4">
                <input type="text" id="shareableLinkInput" readonly class="search-input flex-grow p-2 rounded-l-md bg-gray-700 border-gray-600 text-gray-200 text-xs sm:text-sm">
                <button id="copyShareLinkButton" class="action-button bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-r-md text-sm whitespace-nowrap">
                    Copy
                </button>
            </div>

            <p class="text-sm text-gray-300 mb-2">Or share directly to:</p>
            <div class="space-y-2">
                <button id="facebookShareButton" class="w-full action-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg>
                    Share on Facebook
                </button>
                <button id="xShareButton" class="w-full action-button bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    Share on X
                </button>
                <button id="genericShareButton" class="w-full action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    More Share Options
                </button>
            </div>
        </div>
    </div>

    <!-- How to Get API Key Modal -->
    <div id="howToApiKeyModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 modal hidden"> {/* Higher z-index than other modals */}
        <div class="modal-content w-full max-w-lg rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">How to Get Your Free Google Gemini API Key</h2>
                <button id="closeHowToApiKeyModalButton" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-sm text-gray-300 space-y-3">
                <p>To use the AI features, you'll need a free API key from Google. It's like a special password that lets this app use Google's AI. Here's how:</p>
                <ol class="list-decimal list-inside space-y-2 pl-4">
                    <li><strong>Go to Google AI Studio:</strong> Click this link: 
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Get API Key</a> (opens in a new tab).
                    </li>
                    <li><strong>Sign In:</strong> If you're not already, sign in with your Google account.</li>
                    <li><strong>Create or Select a Project:</strong>
                        <ul class="list-disc list-inside pl-4 text-xs">
                            <li>You might be asked to create a "New project" or select an existing one.</li>
                            <li>If creating a new one, you can name it something like "My AI Apps".</li>
                        </ul>
                    </li>
                    <li><strong>Find "Get API key":</strong> Look for a button or option that says "Create API key" or "Get API key" (often associated with your project).</li>
                    <li><strong>Create the Key:</strong> Click the button. You might need to select the project you just created/selected.</li>
                    <li><strong>Copy Your Key:</strong> A long string of letters and numbers will appear. This is your API key! Click the copy icon next to it.</li>
                    <li><strong>Paste it Here:</strong> Come back to this page, paste the copied key into the "Gemini API Key" box, then click "Save Key".</li>
                </ol>
                <p class="font-semibold">Important: Keep your API key safe, like a password. This app will only store it in your browser for this session.</p>
            </div>
        </div>
    </div>


    <script>
        // Candidate Data (Embed for simplicity, ideally from a JSON file)
        let candidatesData = [];

        const candidateGrid = document.getElementById('candidateGrid');
        const searchInput = document.getElementById('searchInput');
        const selectedCountDisplay = document.getElementById('selectedCount');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noSelectionsMessage = document.getElementById('noSelectionsMessage');

        const modal = document.getElementById('candidateModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalCandidateNameTitle = document.getElementById('modalCandidateNameTitle');
        const modalCandidatePhoto = document.getElementById('modalCandidatePhoto');
        const modalCandidateName = document.getElementById('modalCandidateName');
        const modalCandidateParty = document.getElementById('modalCandidateParty');
        const modalShortBio = document.getElementById('modalShortBio');
        const modalEducation = document.getElementById('modalEducation');
        const modalWorkBackground = document.getElementById('modalWorkBackground');
        const modalLawsAuthored = document.getElementById('modalLawsAuthored');
        const modalContributions = document.getElementById('modalContributions');
        const modalIssuesOrViolations = document.getElementById('modalIssuesOrViolations');
        const modalOtherKeyAspectsContainer = document.getElementById('modalOtherKeyAspectsContainer');
        const modalOtherKeyAspects = document.getElementById('modalOtherKeyAspects');
        const modalSelectButton = document.getElementById('modalSelectButton');

        const allCandidatesTab = document.getElementById('allCandidatesTab');
        const mySenatorsTab = document.getElementById('mySenatorsTab');

        // API Key and AI Search Toggle Elements
        const aiSearchToggle = document.getElementById('aiSearchToggle');
        const aiSearchInfo = document.getElementById('aiSearchInfo');
        const apiKeyControlsContainer = document.getElementById('apiKeyControlsContainer');
        const apiKeyStatusMessage = document.getElementById('apiKeyStatusMessage');
        const apiKeyInputGroup = document.getElementById('apiKeyInputGroup');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton'); // Already declared, but good to group
        const editApiKeyButton = document.getElementById('editApiKeyButton');
        const apiKeyPromptMessage = document.getElementById('apiKeyPromptMessage');
        const aiMySenatorsInsightsButton = document.getElementById('aiMySenatorsInsightsButton');
        const shareSlateButton = document.getElementById('shareSlateButton');

        // My Senators Insights Modal Elements
        const mySenatorsInsightsModal = document.getElementById('mySenatorsInsightsModal');
        const closeMySenatorsInsightsModalButton = document.getElementById('closeMySenatorsInsightsModalButton');
        const closeMySenatorsInsightsModalButtonBottom = document.getElementById('closeMySenatorsInsightsModalButtonBottom');
        const searchSuggestionsContainer = document.getElementById('searchSuggestionsContainer');
        const mySenatorsInsightsOutput = document.getElementById('mySenatorsInsightsOutput');

        // Share Slate Modal Elements
        const shareSlateModal = document.getElementById('shareSlateModal');
        const closeShareSlateModalButton = document.getElementById('closeShareSlateModalButton');
        const shareableLinkInput = document.getElementById('shareableLinkInput');
        const copyShareLinkButton = document.getElementById('copyShareLinkButton');
        const facebookShareButton = document.getElementById('facebookShareButton');
        const xShareButton = document.getElementById('xShareButton');
        const genericShareButton = document.getElementById('genericShareButton');

        // How to Get API Key Modal Elements
        const howToApiKeyModal = document.getElementById('howToApiKeyModal');
        const closeHowToApiKeyModalButton = document.getElementById('closeHowToApiKeyModalButton');
        const howToGetApiKeyButton = document.getElementById('howToGetApiKeyButton');
        let selectedSenators = JSON.parse(localStorage.getItem('selectedSenators')) || [];
        let currentFilter = 'all'; // 'all' or 'selected'
        let currentCandidateIdInModal = null;
        let geminiApiKey = "AIzaSyCpWKyKJsobDUEDg4nrDNRm4dz31XNvdoQ"; // Pre-configured API Key
        let currentNavigationList = []; // Holds the list for modal navigation and tab count reference
        let aiSearchEnabled = true; // AI Search enabled by default
        let searchDebounceTimer;
        
        let lastSearchedTerm = null; // Cache for the last search term
        let lastFullSearchResults = null; // Cache for the full results of the last search

        const defaultSearchPlaceholder = "Search candidates...";
        const aiSearchPlaceholder = "Ask about platforms, stances, or attributes (AI Search)";

        const spinnerSVG = `<svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
</svg>`;
        const searchIconSVG = `<svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
</svg>`;

        const sampleSearchSuggestions = [
            "Who supports environmental protection?",
            "Candidates with experience in law",
            "Senators focused on education reform",
            "What are the platforms on healthcare?",
            "Candidates against death penalty",
            "Candidates endorsed by Leni Robredo",
            "Candidates endorsed by Sarah Duterte",
            "Candidates endorsed by PBBM",
            "Candidates with strong anti-corruption platforms",
            "Candidates with strong economic platforms",
            "Who has authored laws on anti-corruption?"
        ];

        // Function to show non-blocking notifications
        function showNotification(message, type = 'error', duration = 3000) {
            const notificationArea = document.body; // Or a dedicated notification container
            const notification = document.createElement('div');
            notification.className = `notification ${type}`; // 'error' or 'success'
            notification.textContent = message;
            
            notificationArea.appendChild(notification);

            // Trigger the animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); // Small delay to allow CSS transition

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300); // Allow fade out animation to complete
            }, duration);
        }

        // saveApiKey function is no longer needed by the user.

        function updateApiKeySectionVisibility() {
            if (aiSearchEnabled) {
                // Since the API key is pre-configured, we don't need to show input fields.
                // The apiKeyControlsContainer can remain hidden or be removed from HTML.
                // For now, let's ensure it's hidden if AI is on.
                if(apiKeyControlsContainer) apiKeyControlsContainer.classList.add('hidden'); 
                if(apiKeyPromptMessage) apiKeyPromptMessage.classList.add('hidden');
                searchInput.placeholder = aiSearchPlaceholder;
                if(aiSearchInfo) aiSearchInfo.textContent = "AI features are active. Uses Google Gemini.";

            } else {
                if(apiKeyControlsContainer) apiKeyControlsContainer.classList.add('hidden'); // Keep hidden if AI is off too
                if(apiKeyPromptMessage) apiKeyPromptMessage.classList.remove('hidden'); // Show prompt if AI is off
                searchInput.placeholder = defaultSearchPlaceholder;
                apiKeyStatusMessage.textContent = '';
            }
            updateMySenatorsInsightsButtonState(); // Also update the new button's state
            updateShareSlateButtonState();
        }

        function updateMySenatorsInsightsButtonState() {
            if (aiMySenatorsInsightsButton) {
                const isMySenatorsTabActive = currentFilter === 'selected';
                const hasSelectedSenators = selectedSenators.length > 0;

                if (aiSearchEnabled && geminiApiKey && isMySenatorsTabActive && hasSelectedSenators) {
                    aiMySenatorsInsightsButton.disabled = false;
                    aiMySenatorsInsightsButton.title = "Get AI insights for your selected senators";
                } else {
                    aiMySenatorsInsightsButton.disabled = true;
                    if (!aiSearchEnabled) {
                        aiMySenatorsInsightsButton.title = "Enable AI Search to use this feature.";
                    } else if (!geminiApiKey) {
                        aiMySenatorsInsightsButton.title = "Enter your Gemini API Key to use this feature.";
                    } else if (!isMySenatorsTabActive) {
                        aiMySenatorsInsightsButton.title = "Switch to 'My Senators' tab to use this feature.";
                    } else if (!hasSelectedSenators) {
                        aiMySenatorsInsightsButton.title = "Select at least one senator to get insights.";
                    } else {
                        aiMySenatorsInsightsButton.title = "This feature is currently unavailable.";
                    }
                }
            }
        }

        function updateShareSlateButtonState() {
            if (shareSlateButton) {
                const isMySenatorsTabActive = currentFilter === 'selected';
                const hasSelectedSenators = selectedSenators.length > 0;

                if (isMySenatorsTabActive) {
                    shareSlateButton.disabled = false;
                    shareSlateButton.title = hasSelectedSenators ? "Share your current slate of selected senators" : "Select senators to share your slate";
                } else {
                    shareSlateButton.disabled = true;
                    if (!isMySenatorsTabActive) {
                        shareSlateButton.title = "Switch to 'My Senators' tab to share your slate.";
                    // This case is now covered by the enabled state above
                    // } else if (!hasSelectedSenators) { 
                    //     shareSlateButton.title = "Select at least one senator to share your slate.";
                    } else {
                        shareSlateButton.title = "Sharing is currently unavailable.";
                    }
                }
            }
        }

        function updateSelectedCount() {
            selectedCountDisplay.textContent = selectedSenators.length;
            if (currentCandidateIdInModal !== null) {
                const isSelected = selectedSenators.includes(currentCandidateIdInModal);
                modalSelectButton.textContent = isSelected ? 'Remove from My Senators' : 'Add to My Senators';
                modalSelectButton.classList.toggle('bg-red-600', isSelected);
                modalSelectButton.classList.toggle('hover:bg-red-700', isSelected);
                modalSelectButton.classList.toggle('bg-indigo-600', !isSelected);
                modalSelectButton.classList.toggle('hover:bg-indigo-700', !isSelected);
            }
            updateMySenatorsInsightsButtonState();
            updateShareSlateButtonState();
        }

        function saveSelectedSenators() {
            localStorage.setItem('selectedSenators', JSON.stringify(selectedSenators));
        }

        async function searchWithGemini(query, candidates) {
            if (!geminiApiKey) {
                showNotification('Gemini API Key not set for AI Search. Using local search.', 'error');
                // Fallback to local search
                return candidates.filter(candidate =>
                    candidate.name.toLowerCase().includes(query.toLowerCase()) ||
                    candidate.political_party.toLowerCase().includes(query.toLowerCase())
                );
            }

            const searchIconContainer = searchInput.parentElement.querySelector('.absolute.inset-y-0.left-0.pl-3.flex.items-center');
            const originalIconHTML = searchIconContainer ? searchIconContainer.innerHTML : searchIconSVG;
            if (searchIconContainer) searchIconContainer.innerHTML = spinnerSVG;

            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${geminiApiKey}`;

            // Prepare detailed candidate information for the prompt, similar to fetchAiSuggestions
            const detailedCandidatesForPrompt = candidates.map(c => ({
                candidate_number: c.candidate_number,
                name: c.name,
                political_party: c.political_party,
                age: c.basic_information.age,
                residence: c.basic_information.residence,
                education: c.education.map(e => `${e.degree} at ${e.institution}`).join('; ') || "N/A",
                job_affiliations: c.job_affiliations.join('; ') || "N/A",
                govt_experience: c.govt_experience.join('; ') || "N/A",
                platforms: c.platforms.join('; ') || "N/A",
                in_favor: c.in_favor.join('; ') || "N/A",
                against: c.against.join('; ') || "N/A",
                laws_passed: c.laws_passed.join('; ') || "N/A",
                family_members_in_politics: c.family_members_in_politics.map(f => `${f.name} (${f.relation}) - ${f.position}`).join('; ') || "N/A"
            }));

            const prompt = `
                You are an AI assistant helping a user find Philippine senatorial candidates that match their query.
                The user will provide a search query. Your task is to:
                1. Understand the user's query. Use your general knowledge, including your understanding of current events (up to your last training data), to identify key concepts, desired attributes, specific platforms, or political leanings implied by the query. For example, if the query is "candidates for environmental protection", you should look for candidates with platforms related to climate change, conservation, renewable energy, etc. If the query relates to a recent event or policy debate, factor that into your interpretation.
                2. Review the provided list of candidates and their details (name, political party, education, experience, platforms, stances, laws passed).
                3. Identify candidates from THIS SPECIFIC LIST whose profiles (based on the provided data) align with the interpreted meaning of the user's query.
                4. Return a JSON array of "candidate_number" (integer) for the matching candidates from the provided list.
                5. If no candidates from the list strongly match the interpreted query, return an empty JSON array: [].
                
                Do not include any explanations, apologies, or introductory text. Your entire response must be only the JSON array of numbers.
                For example, if candidates with numbers 3, 7, and 12 match, your response should be exactly: [3, 7, 12]

                Candidate List:
                ${JSON.stringify(detailedCandidatesForPrompt)}

                User Query: "${query}"

                Matching candidate_numbers (JSON array of integers):
            `;

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.2 } // Lower temperature for more factual/deterministic output
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    showNotification(`Gemini API Error: ${errorData.error?.message || response.statusText}`, 'error');
                    return [];
                }

                const data = await response.json();
                let resultText = '';

                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    resultText = data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    showNotification(`Gemini content blocked: ${data.promptFeedback.blockReason?.reason || data.promptFeedback.blockReason}`, 'error');
                    console.error('Gemini API Blocked:', data.promptFeedback);
                    return [];
                } else {
                    console.error('Unexpected Gemini API response structure:', data);
                    showNotification('Error parsing Gemini response. Check console.', 'error');
                    return [];
                }

                resultText = resultText.replace(/^```json\s*|```\s*$/g, '').trim();
                let matchingCandidateNumbers;
                try {
                    matchingCandidateNumbers = JSON.parse(resultText);
                    if (!Array.isArray(matchingCandidateNumbers) || !matchingCandidateNumbers.every(num => typeof num === 'number')) {
                        console.error('Gemini API did not return a valid JSON array of numbers:', resultText);
                        showNotification('AI search returned an unexpected format.', 'error');
                        return [];
                    }
                } catch (e) {
                    console.error('Error parsing JSON from Gemini:', e, "Raw response:", resultText);
                    showNotification('Error processing AI search results.', 'error');
                    return [];
                }
                return candidates.filter(c => matchingCandidateNumbers.includes(c.candidate_number));
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                showNotification('Failed to connect to AI search service.', 'error');
                return [];
            } finally {
                if (searchIconContainer) searchIconContainer.innerHTML = originalIconHTML;
            }
        }

        async function callGenericTextAI(promptText, outputElement, actionButtonsToToggle) {
            if (!aiSearchEnabled) {
                outputElement.textContent = 'AI Search is not enabled. Please enable it and provide an API key.';
                outputElement.style.display = 'block';
                showNotification('AI Search is not enabled.', 'error');
                return;
            }
            if (!geminiApiKey) {
                outputElement.textContent = 'Gemini API Key not set. Please set it in the AI Search section.';
                outputElement.style.display = 'block';
                showNotification('Gemini API Key not set for AI features.', 'error');
                return;
            }

            actionButtonsToToggle.forEach(btn => btn.disabled = true);
            outputElement.innerHTML = `<div class="flex items-center justify-center"><span class="inline-block align-middle">${spinnerSVG}</span><span class="ml-2">Processing your request...</span></div>`;
            outputElement.style.display = 'block';

            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        generationConfig: { temperature: 0.4 } // Adjust temperature as needed
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    const errorMessage = `Gemini API Error: ${errorData.error?.message || response.statusText}`;
                    outputElement.textContent = errorMessage;
                    showNotification(errorMessage, 'error');
                    return;
                }

                const data = await response.json();
                let resultText = '';

                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    resultText = data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    const blockMessage = `Gemini content blocked: ${data.promptFeedback.blockReason?.reason || data.promptFeedback.blockReason}`;
                    outputElement.textContent = blockMessage;
                    showNotification(blockMessage, 'error');
                    console.error('Gemini API Blocked:', data.promptFeedback);
                    return;
                } else {
                    console.error('Unexpected Gemini API response structure:', data);
                    outputElement.textContent = 'Error parsing Gemini response. Check console.';
                    showNotification('Error parsing Gemini response. Check console.', 'error');
                    return;
                }
                outputElement.textContent = resultText.trim();

            } catch (error) {
                console.error('Error calling Gemini API for text generation:', error);
                outputElement.textContent = 'Failed to connect to AI service for this feature.';
                showNotification('Failed to connect to AI service.', 'error');
            } finally {
                actionButtonsToToggle.forEach(btn => btn.disabled = false);
            }
        }

        function handleSummarizeDetails(candidate, outputElement, actionButtons) {
            const prompt = `
                You are an AI assistant. Based on the following structured information about a political candidate, provide a concise summary (2-3 paragraphs) highlighting their key qualifications, political party, main platforms, and notable stances.

                Candidate Data:
                Name: ${candidate.name}
                Party: ${candidate.political_party}
                Age: ${candidate.basic_information.age}
                Residence: ${candidate.basic_information.residence}
                Education: ${JSON.stringify(candidate.education.map(e => `${e.degree} at ${e.institution}`).join(', ') || "N/A")}
                Platforms: ${JSON.stringify(candidate.platforms.join(', ') || "N/A")}
                In Favor Of: ${JSON.stringify(candidate.in_favor.join(', ') || "N/A")}
                Against: ${JSON.stringify(candidate.against.join(', ') || "N/A")}

                Concise Summary:
            `;
            callGenericTextAI(prompt, outputElement, actionButtons);
        }

        function handleCheckNegativeIssues(candidate, outputElement, actionButtons) {
            const prompt = `
                You are an AI assistant providing publicly known information.
                Regarding the public figure "${candidate.name}", are there any widely reported significant controversies, criminal charges, or major negative issues associated with them based on your knowledge up to your last training data?
                Please be factual and neutral. If there are notable issues, briefly mention them. If you have no specific information on significant negative issues, please state that.
                Do not speculate. Focus on information that is generally part of the public record or widely discussed in reputable media.

                Information:
            `;
            callGenericTextAI(prompt, outputElement, actionButtons);
        }

        function handleSummarizeContributions(candidate, outputElement, actionButtons) {
            const prompt = `
                You are an AI assistant. Based on the provided data and your general knowledge, summarize the key contributions and achievements of the political candidate "${candidate.name}".
                Consider their roles in government, laws they may have influenced or passed (such as these: ${JSON.stringify(candidate.laws_passed.join(', ') || "N/A")}), and significant initiatives they've been part of from their listed government experience (such as these: ${JSON.stringify(candidate.govt_experience.join(', ') || "N/A")}).
                Provide a comprehensive overview of their contributions throughout their career, if information is available.

                Summary of Contributions:
            `;
            callGenericTextAI(prompt, outputElement, actionButtons);
        }

        async function fetchMySenatorsInsights() {
            if (selectedSenators.length === 0) {
                showNotification('Please select at least one senator to get insights for your slate.', 'error');
                return;
            }
            if (!aiSearchEnabled || !geminiApiKey) {
                showNotification('AI Search must be enabled and API key provided for this feature.', 'error');
                return;
            }

            const selectedCandidatesDetails = candidatesData
                .filter(c => selectedSenators.includes(c.candidate_number))
                .map(c => ({ // Send a subset of details, similar to aiSuggestButton
                    name: c.name,
                    political_party: c.political_party,
                    age: c.basic_information.age,
                    residence: c.basic_information.residence,
                    education: c.education.map(e => `${e.degree} at ${e.institution}`).join('; ') || "N/A",
                    job_affiliations: c.job_affiliations.join('; ') || "N/A",
                    govt_experience: c.govt_experience.join('; ') || "N/A",
                    platforms: c.platforms.join('; ') || "N/A",
                    in_favor: c.in_favor.join('; ') || "N/A",
                    against: c.against.join('; ') || "N/A",
                    laws_passed: c.laws_passed.join('; ') || "N/A"
                }));

            const prompt = `
                You are an AI political analyst. I have selected the following group of Philippine senatorial candidates.
                Based on their provided details (name, party, age, residence, education, job affiliations, government experience, platforms, stances, laws passed), please provide an overall analysis of this selection as a potential "slate" or group.

                Consider these aspects in your analysis:
                1.  **Common Ground & Potential Synergy**: Common themes, overlapping platforms, or shared stances.
                2.  **Diversity of Expertise & Background**: Range of experiences, educational backgrounds.
                3.  **Collective Strengths**: Potential combined strengths if elected.
                4.  **Potential Gaps or Weaknesses**: Obvious gaps in expertise or representation.
                5.  **Overall Political Leanings/Profile**: General political profile based on party/stances.
                6.  **Potential Legislative Focus**: Primary legislative focus based on platforms/laws.

                Provide a concise, balanced, and insightful summary. Avoid definitive election predictions.

                Selected Candidates Data:
                ${JSON.stringify(selectedCandidatesDetails)}

                Analysis:
            `;

            mySenatorsInsightsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Use callGenericTextAI to handle the API call and display
            // The actionButtonsToToggle for this call would be the aiMySenatorsInsightsButton itself
            callGenericTextAI(prompt, mySenatorsInsightsOutput, [aiMySenatorsInsightsButton]);
        }

        function handleShareSlate() {
            if (selectedSenators.length === 0) {
                showNotification('Please select some senators before sharing.', 'error');
                return;
            }
            const slateQueryParam = selectedSenators.join(',');
            const shareUrl = `${window.location.origin}${window.location.pathname}?slate=${slateQueryParam}`;
            
            shareableLinkInput.value = shareUrl;
            shareSlateModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function copyShareLink() {
            shareableLinkInput.select();
            shareableLinkInput.setSelectionRange(0, 99999); // For mobile devices
            try {
                navigator.clipboard.writeText(shareableLinkInput.value);
                showNotification('Share link copied to clipboard!', 'success');
            } catch (err) {
                showNotification('Failed to copy link. Please copy it manually.', 'error');
                console.error('Failed to copy text: ', err);
            }
        }

        function shareToFacebook() {
            const shareUrl = shareableLinkInput.value;
            if (!shareUrl) return;
            const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
            window.open(fbShareUrl, '_blank', 'noopener,noreferrer,width=600,height=400');
        }

        function shareToX() {
            const shareUrl = shareableLinkInput.value;
            if (!shareUrl) return;
            const text = encodeURIComponent("Check out my Philippine Senatorial Slate for 2025! #Halalan2025 #PHVote");
            const xShareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${text}`;
            window.open(xShareUrl, '_blank', 'noopener,noreferrer,width=600,height=400');
        }

        async function shareGeneric() {
            const shareUrl = shareableLinkInput.value;
            if (!shareUrl) return;
            const shareData = {
                title: 'My Senatorial Slate 2025',
                text: 'Check out my Philippine Senatorial Slate for 2025! #Halalan2025',
                url: shareUrl,
            };
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    showNotification('Slate shared successfully!', 'success');
                } catch (err) {
                    console.error('Error using Web Share API:', err);
                    showNotification('Could not share. Link copied instead.', 'error'); copyShareLink();
                }
            } else { showNotification('Web Share not supported. Link copied instead.', 'error'); copyShareLink(); }
        }
        // Function to specifically update the "All Candidates" tab label
        function updateAllCandidatesTabLabel(count) {
            allCandidatesTab.innerHTML = `All Candidates (${count})`;
        }

        function renderCandidatesFromList(listToRender, searchTerm = '', currentTab = 'all') {
            candidateGrid.innerHTML = '';
            noResultsMessage.classList.add('hidden');
            noSelectionsMessage.classList.add('hidden');

            const candidatesToDisplay = listToRender;

            currentNavigationList = candidatesToDisplay; // Update the list for modal navigation

            if (candidatesToDisplay.length === 0) {
                if (searchTerm) {
                    noResultsMessage.classList.remove('hidden');
                } else if (currentTab === 'selected') {
                    noSelectionsMessage.classList.remove('hidden');
                }
                 // If 'all' tab and empty, initial load message should handle it.
                return;
            }

             candidatesToDisplay.forEach(candidate => {
                const card = document.createElement('div');
                card.className = `candidate-card fade-in relative group bg-gray-800 rounded-lg shadow-lg p-5 cursor-pointer flex flex-col items-center text-center ${selectedSenators.includes(candidate.candidate_number) ? 'selected' : ''}`;
                card.dataset.id = candidate.candidate_number;

                const image = document.createElement('img');
                image.src = './img/' + candidate.photo;
                image.alt = candidate.name;
                image.className = 'w-32 h-32 object-cover rounded-full mb-4 border-2 border-gray-700';

                const name = document.createElement('h3');
                name.className = 'text-xl font-semibold text-white mb-1';
                name.textContent = candidate.name;

                const party = document.createElement('p');
                party.className = 'text-sm text-indigo-400';
                party.textContent = candidate.political_party;

                // Add/Remove Button
                const addButton = document.createElement('button');
                addButton.className = 'absolute top-3 right-3 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-all duration-200 z-10';
                addButton.setAttribute('aria-label', 'Add or remove candidate');

                const updateAddButtonState = () => {
                    if (selectedSenators.includes(candidate.candidate_number)) {
                        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`; // Check icon
                        addButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        addButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    } else {
                        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`; // Plus icon
                        addButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                        addButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }
                };
                updateAddButtonState();

                addButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent card click (modal opening)
                    const candidateId = candidate.candidate_number;
                    const index = selectedSenators.indexOf(candidateId);

                    if (index > -1) {
                        selectedSenators.splice(index, 1);
                        showNotification(`${candidate.name} removed from your senators.`, 'success');
                    } else {
                        if (selectedSenators.length < 12) {
                            selectedSenators.push(candidateId);
                            showNotification(`${candidate.name} added to your senators.`, 'success');
                        } else {
                            showNotification('You can only select up to 12 senators.', 'error');
                            return;
                        }
                    }

                    saveSelectedSenators();
                    updateSelectedCount();
                    updateAddButtonState();
                    card.classList.toggle('selected', selectedSenators.includes(candidateId));

                    if (currentFilter === 'selected' && index > -1) {
                        // Re-render "My Senators" tab if an item was removed
                        performSearchAndRender(searchInput.value.trim(), 'selected');
                    }

                });

                // Add candidate number overlay
                const candidateNumberOverlay = document.createElement('div');
                candidateNumberOverlay.className = 'absolute bottom-2 left-2 text-gray-100 text-xs font-semibold bg-gray-700 bg-opacity-75 rounded-md px-2 py-1';
                candidateNumberOverlay.textContent = `#${candidate.candidate_number}`;

                card.appendChild(image);
                card.appendChild(name);
                card.appendChild(party);
                card.appendChild(addButton); // Ensure the add button is appended to the card
                card.appendChild(candidateNumberOverlay);

                card.addEventListener('click', () => openModal(candidate.candidate_number));
                candidateGrid.appendChild(card);
            });
        }

        async function performSearchAndRender(searchTerm, tab) {
            searchTerm = searchTerm.trim();
            let listForCurrentTabDisplay; // This will hold the candidates to actually render

            // Check if we need to perform a new search or can use cached results
            if (searchTerm !== lastSearchedTerm || lastFullSearchResults === null) {
                // New search or search term cleared, or no cached results
                lastSearchedTerm = searchTerm; // Update the cached search term

                if (searchTerm) {
                    if (aiSearchEnabled) {
                        candidateGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full py-10">
                            <span class="inline-block align-middle">${spinnerSVG}</span>
                            <span class="inline-block align-middle ml-2">AI is searching for "${searchTerm}"...</span>
                        </p>`;
                        lastFullSearchResults = await searchWithGemini(searchTerm, candidatesData);
                    } else { // Local search
                        const termLower = searchTerm.toLowerCase();
                        lastFullSearchResults = candidatesData.filter(candidate =>
                            candidate.name.toLowerCase().includes(termLower) ||
                            candidate.political_party.toLowerCase().includes(termLower)
                        );
                    }
                } else { // No search term, show all (or all selected)
                    lastFullSearchResults = [...candidatesData]; // Reset to full list if search term is cleared
                }
            }
            // At this point, lastFullSearchResults contains the results for lastSearchedTerm (or all candidates if term is empty)

            // Update the "All Candidates" tab label based on the count of the full search results (if a search term exists)
            // or the total number of candidates (if no search term).
            if (lastSearchedTerm) {
                updateAllCandidatesTabLabel(lastFullSearchResults.length);
            } else {
                updateAllCandidatesTabLabel(candidatesData.length);
            }

            // Now, filter lastFullSearchResults based on the current tab
            if (tab === 'all') {
                listForCurrentTabDisplay = lastFullSearchResults;
            } else { // tab is 'selected'
                listForCurrentTabDisplay = lastFullSearchResults.filter(c => selectedSenators.includes(c.candidate_number));
            }

            renderCandidatesFromList(listForCurrentTabDisplay, searchTerm, tab);
        }

        function populateModal(candidate) {
            currentCandidateIdInModal = candidate.candidate_number;
            modalCandidateNameTitle.textContent = candidate.name;
            modalCandidatePhoto.src = './img/' + candidate.photo || 'https://placehold.co/300x300/E0E0E0/757575?text=No+Image';
            modalCandidatePhoto.alt = candidate.name;
            modalCandidateParty.textContent = candidate.political_party;
            modalCandidateAge.textContent = `Age: ${candidate.basic_information.age}`;
            modalCandidateResidence.textContent = `Residence: ${candidate.basic_information.residence}`;

            const profileLink = candidate.profile_link || '#';
            const modalProfileLink = document.getElementById('modalProfileLink');
            modalProfileLink.href = profileLink;
            modalProfileLink.classList.toggle('hidden', profileLink === '#');

            const populateList = (element, items, formatter) => {
                element.innerHTML = '';
                if (items && items.length > 0) {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = formatter(item);
                        element.appendChild(li);
                    });
                } else {
                    element.innerHTML = '<li>No information available.</li>';
                }
            };

            populateList(modalEducation, candidate.education, item => `<strong>${item.degree}</strong> - ${item.institution}`);
            populateList(modalJobAffiliations, candidate.job_affiliations, item => item);
            populateList(modalGovtExperience, candidate.govt_experience, item => item);
            populateList(modalPlatforms, candidate.platforms, item => item);
            populateList(modalInFavor, candidate.in_favor, item => item);
            populateList(modalAgainst, candidate.against, item => item);
            populateList(modalFamilyMembers, candidate.family_members_in_politics, item => `<strong>${item.name}</strong> (${item.relation}) - ${item.position}`);
            populateList(modalLawsPassed, candidate.laws_passed, item => item);

            updateSelectedCount();

            // Show/hide prev/next buttons based on the current navigation list
            const prevButton = document.getElementById('prevCandidateButton');
            const nextButton = document.getElementById('nextCandidateButton');
            if (currentNavigationList.length <= 1) {
                prevButton.classList.add('hidden');
                nextButton.classList.add('hidden');
            } else {
                prevButton.classList.remove('hidden');
                nextButton.classList.remove('hidden');
            }

            // AI Insights Section
            const aiInsightsSection = document.getElementById('aiInsightsSection');
            const aiModalOutput = document.getElementById('aiModalOutput');
            const aiSummarizeDetailsButton = document.getElementById('aiSummarizeDetailsButton');
            const aiCheckIssuesButton = document.getElementById('aiCheckIssuesButton');
            const aiSummarizeContributionsButton = document.getElementById('aiSummarizeContributionsButton');
            const aiActionButtons = [aiSummarizeDetailsButton, aiCheckIssuesButton, aiSummarizeContributionsButton];

            aiInsightsSection.style.display = aiSearchEnabled ? 'block' : 'none';
            aiModalOutput.style.display = 'none'; // Hide output initially
            aiSummarizeDetailsButton.onclick = () => handleSummarizeDetails(candidate, aiModalOutput, aiActionButtons);
            aiCheckIssuesButton.onclick = () => handleCheckNegativeIssues(candidate, aiModalOutput, aiActionButtons);
            aiSummarizeContributionsButton.onclick = () => handleSummarizeContributions(candidate, aiModalOutput, aiActionButtons);
        }

        function openModal(candidateNumber) {
            const candidate = candidatesData.find(c => c.candidate_number === candidateNumber); // Match by candidate_number
            if (candidate) {
                populateModal(candidate);
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Reset AI output area
                const aiModalOutput = document.getElementById('aiModalOutput');
                if (aiModalOutput) {
                    aiModalOutput.style.display = 'none';
                    aiModalOutput.textContent = '';
                }
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            currentCandidateIdInModal = null;
            document.body.style.overflow = 'auto';
        }

        function closeShareSlateModal() {
            shareSlateModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function closeMySenatorsInsightsModal() {
            mySenatorsInsightsModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        function navigateCandidate(direction) {
            if (!currentCandidateIdInModal) return;
            const currentIndex = currentNavigationList.findIndex(c => c.candidate_number === currentCandidateIdInModal);
            if (currentIndex === -1) return;

            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = currentNavigationList.length - 1; // Wrap to last candidate
            if (newIndex >= currentNavigationList.length) newIndex = 0; // Wrap to first candidate

            openModal(currentNavigationList[newIndex].candidate_number);
        }

        // Add swipe functionality
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) navigateCandidate(1); // Swipe left for next
            if (touchEndX > touchStartX + 50) navigateCandidate(-1); // Swipe right for previous
        }

        modal.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        modal.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function renderSearchSuggestions(query = "") {
            searchSuggestionsContainer.innerHTML = '';
            const filteredSuggestions = sampleSearchSuggestions.filter(suggestion => 
                suggestion.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredSuggestions.length === 0 && !query) { // Show all if no query and no filter results (e.g. initial focus)
                 sampleSearchSuggestions.forEach(suggestionText => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item p-2 cursor-pointer text-sm text-gray-300 hover:bg-gray-700';
                    item.textContent = suggestionText;
                    item.addEventListener('mousedown', () => { // mousedown to fire before blur
                        searchInput.value = suggestionText;
                        searchSuggestionsContainer.classList.add('hidden');
                        performSearchAndRender(suggestionText, currentFilter);
                    });
                    searchSuggestionsContainer.appendChild(item);
                });
            } else {
                filteredSuggestions.forEach(suggestionText => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item p-2 cursor-pointer text-sm text-gray-300';
                    item.textContent = suggestionText;
                    item.addEventListener('mousedown', () => {
                        searchInput.value = suggestionText;
                        searchSuggestionsContainer.classList.add('hidden');
                        performSearchAndRender(suggestionText, currentFilter);
                    });
                    searchSuggestionsContainer.appendChild(item);
                });
            }
            searchSuggestionsContainer.classList.toggle('hidden', filteredSuggestions.length === 0 && query.length > 0);
        }

        // Event Listeners for navigation buttons
        document.getElementById('prevCandidateButton').addEventListener('click', () => navigateCandidate(-1));
        document.getElementById('nextCandidateButton').addEventListener('click', () => navigateCandidate(1));

        // Event Listeners
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(async () => {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    searchSuggestionsContainer.classList.add('hidden'); // Hide suggestions once search is triggered
                } else {
                    renderSearchSuggestions(); // Show all suggestions if input is cleared
                    searchSuggestionsContainer.classList.remove('hidden');
                }
                performSearchAndRender(searchTerm, currentFilter);
            }, 1500);
            renderSearchSuggestions(e.target.value); // Filter suggestions as user types
        });

        searchInput.addEventListener('focus', () => {
            renderSearchSuggestions(searchInput.value);
            if (searchSuggestionsContainer.children.length > 0) searchSuggestionsContainer.classList.remove('hidden');
        });
        searchInput.addEventListener('blur', () => {
            setTimeout(() => searchSuggestionsContainer.classList.add('hidden'), 150); // Delay to allow click on suggestion
        });
        closeModalButton.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        modalSelectButton.addEventListener('click', () => {
            if (currentCandidateIdInModal === null) return;

            const candidateId = currentCandidateIdInModal;
            const candidate = candidatesData.find(c => c.candidate_number === candidateId); // Match by candidate_number
            if (!candidate) return;

            const index = selectedSenators.indexOf(candidateId);

            if (index > -1) {
                // Remove from My Senators
                selectedSenators.splice(index, 1);
                showNotification(`${candidate.name} removed from your senators.`, 'success');
            } else {
                // Add to My Senators if limit is not exceeded
                if (selectedSenators.length < 12) {
                    selectedSenators.push(candidateId);
                    showNotification(`${candidate.name} added to your senators.`, 'success');
                } else {
                    showNotification('You can only select up to 12 senators.', 'error');
                    return;
                }
            }

            saveSelectedSenators();
            updateSelectedCount(); // Update modal button and count display

            // Update the corresponding card in the grid
            const cardInGrid = candidateGrid.querySelector(`.candidate-card[data-id='${candidateId}']`);
            if (cardInGrid) {
                cardInGrid.classList.toggle('selected', selectedSenators.includes(candidateId));
            }

            // If on "My Senators" tab and a senator is removed, re-render
            if (currentFilter === 'selected' && index > -1) {
                performSearchAndRender(searchInput.value, 'selected');
            }
        });

        allCandidatesTab.addEventListener('click', () => {
            currentFilter = 'all';
            allCandidatesTab.classList.add('active');
            mySenatorsTab.classList.remove('active');
            updateMySenatorsInsightsButtonState();
            performSearchAndRender(searchInput.value, 'all');
        });

        if (shareSlateButton) {
            shareSlateButton.addEventListener('click', handleShareSlate);
        }

        mySenatorsTab.addEventListener('click', () => {
            currentFilter = 'selected';
            updateMySenatorsInsightsButtonState();
            mySenatorsTab.classList.add('active');
            allCandidatesTab.classList.remove('active');
            performSearchAndRender(searchInput.value, 'selected');
        });

        if (aiMySenatorsInsightsButton) {
            aiMySenatorsInsightsButton.addEventListener('click', fetchMySenatorsInsights);
        }

        // Event listeners for the new modal
        if (closeMySenatorsInsightsModalButton) {
            closeMySenatorsInsightsModalButton.addEventListener('click', closeMySenatorsInsightsModal);
        }
        if (closeMySenatorsInsightsModalButtonBottom) {
            closeMySenatorsInsightsModalButtonBottom.addEventListener('click', closeMySenatorsInsightsModal);
        }
        if (mySenatorsInsightsModal) {
            mySenatorsInsightsModal.addEventListener('click', (e) => {
                if (e.target === mySenatorsInsightsModal) closeMySenatorsInsightsModal();
            });
        }

        // Event listeners for Share Slate Modal
        if (closeShareSlateModalButton) {
            closeShareSlateModalButton.addEventListener('click', closeShareSlateModal);
        }
        if (copyShareLinkButton) {
            copyShareLinkButton.addEventListener('click', copyShareLink);
        }
        if (facebookShareButton) {
            facebookShareButton.addEventListener('click', shareToFacebook);
        }
        if (xShareButton) {
            xShareButton.addEventListener('click', shareToX);
        }
        if (genericShareButton) {
            genericShareButton.addEventListener('click', shareGeneric);
        }
        if (shareSlateModal) {
            shareSlateModal.addEventListener('click', (e) => {
                if (e.target === shareSlateModal) closeShareSlateModal();
            });
        }

        // Event listeners for How to Get API Key Modal
        if (howToGetApiKeyButton) {
            howToGetApiKeyButton.addEventListener('click', () => {
                howToApiKeyModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            });
        }
        if (closeHowToApiKeyModalButton) {
            closeHowToApiKeyModalButton.addEventListener('click', () => {
                howToApiKeyModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        }
        if (howToApiKeyModal) {
            howToApiKeyModal.addEventListener('click', (e) => { if (e.target === howToApiKeyModal) { howToApiKeyModal.classList.add('hidden'); document.body.style.overflow = 'auto'; } });
        }

        async function initializeCandidates() {
            candidatesData = await fetchCandidates();

            // Check for slate in URL params before doing anything else
            const urlParams = new URLSearchParams(window.location.search);
            const slateParam = urlParams.get('slate');
            if (slateParam) {
                const slateCandidateNumbers = slateParam.split(',')
                    .map(numStr => parseInt(numStr.trim(), 10))
                    .filter(num => !isNaN(num));
                
                // Filter against actual candidate numbers to ensure validity and avoid duplicates
                selectedSenators = candidatesData.filter(c => slateCandidateNumbers.includes(c.candidate_number)).map(c => c.candidate_number);
                if (selectedSenators.length > 12) selectedSenators = selectedSenators.slice(0, 12); // Enforce limit
                saveSelectedSenators();
                // Clear the slate parameter from URL to avoid re-processing on refresh
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (candidatesData.length === 0) {
                candidateGrid.innerHTML = '<p class="text-center text-gray-400 mt-10 text-xl col-span-full">Failed to load candidate data or no data available.</p>';
                noResultsMessage.classList.add('hidden');
                updateAllCandidatesTabLabel(0);
                mySenatorsTab.classList.remove('active'); // Ensure 'All' tab seems primary
                allCandidatesTab.classList.add('active');
                return;
            }
            // Sort candidates by candidate_number
            candidatesData.sort((a, b) => a.candidate_number - b.candidate_number);
            currentNavigationList = [...candidatesData]; // Initialize navigation list
            updateAllCandidatesTabLabel(candidatesData.length); // Initial count for "All Candidates" tab
            updateSelectedCount(); // Initial count for "My Senators" tab
            updateShareSlateButtonState(); // Update share button state after potential load from URL
            if (slateParam && selectedSenators.length > 0) { // If slate was loaded from URL, switch to My Senators tab
                mySenatorsTab.click(); // Programmatically click the tab
                return; // performSearchAndRender will be called by the tab click
            }
            performSearchAndRender('', currentFilter); // Initial render
        }

        document.addEventListener('DOMContentLoaded', () => {
            aiSearchToggle.checked = aiSearchEnabled;
            // Set initial placeholder based on aiSearchEnabled state
            updateMySenatorsInsightsButtonState(); // Initial state for the new button
            updateShareSlateButtonState(); // Initial state for share button
            updateApiKeySectionVisibility();

            // Remove event listeners for save/edit API key as they are no longer user-facing
            // saveApiKeyButton.addEventListener('click', saveApiKey);
            // editApiKeyButton.addEventListener('click', ...);

            aiSearchToggle.addEventListener('change', () => {
                aiSearchEnabled = aiSearchToggle.checked;
                sessionStorage.setItem('aiSearchEnabled', JSON.stringify(aiSearchEnabled));
                updateApiKeySectionVisibility();
                // If modal is open, update visibility of AI section
                if (!modal.classList.contains('hidden') && currentCandidateIdInModal) {
                    const candidate = candidatesData.find(c => c.candidate_number === currentCandidateIdInModal);
                    if (candidate) populateModal(candidate); // Re-populate to show/hide AI section
                }
                performSearchAndRender(searchInput.value.trim(), currentFilter); // Re-filter/render main grid

                // The notification for missing API key is no longer relevant as it's pre-configured.
                updateMySenatorsInsightsButtonState();
                updateShareSlateButtonState();
            });

            initializeCandidates();
        });
    </script>
    <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-10">
        <p class="text-sm">
            AI Search powered by Google Gemini. Results depend on the model's interpretation of the query and provided data.
        </p>
        <p class="text-sm mt-2">
            Disclaimer: The data in this project is for informational purposes only and is based on publicly available information. While efforts were made to ensure accuracy, there may be discrepancies due to the nature of manual scraping, AI processing, and the dynamic nature of election-related data. Users are encouraged to verify the information from official sources.
        </p>
        <p class="text-sm mt-4">
            All data is stored locally on your device and is not processed by any external servers or applications.
        </p>
        <p class="text-sm mt-4">
            Sources: 
            <a href="https://www.facebook.com/philstarnews" target="_blank" class="text-indigo-400 hover:underline">PhilStar</a>, 
            <a href="https://www.facebook.com/NUDNUntium" target="_blank" class="text-indigo-400 hover:underline">The NUntium</a>, 
            <a href="https://www.facebook.com/sscalangilan" target="_blank" class="text-indigo-400 hover:underline">Supreme Student Council - BatStateU Alangilan Campus</a>.
        </p>
        <p class="text-sm mt-4">
            Visit the project repository: 
            <a href="https://github.com/kfasides/ph-election-2025" target="_blank" class="text-indigo-400 hover:underline">GitHub Repository</a>.
        </p>
    </footer>
</body>
</html>
