<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philippine Senatorial Candidates 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f3f4f6; /* Light text */
        }
        .candidate-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden; /* Ensures image corners are rounded with the card */
            position: relative; /* Required for absolute positioning of the hover button */
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 2px #4f46e5; /* Indigo focus ring on hover */
        }
        .candidate-card.selected {
            box-shadow: 0 0 0 3px #3b82f6; /* Blue ring for selected */
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay for modal */
        }
        .modal-content {
            background-color: #1f2937; /* Darker modal content bg */
            color: #d1d5db; /* Lighter text for modal content */
            max-height: 90vh;
            overflow-y: auto;
        }
        .tab-button {
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .tab-button.active {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }
        .tab-button:not(.active):hover {
            background-color: #374151; /* Gray-700 for hover on inactive tabs */
        }
        .action-button {
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            opacity: 0.9;
        }
        .search-input {
            background-color: #374151; /* Gray-700 */
            border-color: #4b5563; /* Gray-600 */
            color: #f3f4f6; /* Light text */
        }
        .search-input::placeholder {
            color: #9ca3af; /* Gray-400 */
        }
        /* Custom scrollbar for modal content (optional) */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #374151; /* Gray-700 */
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #4f46e5; /* Indigo */
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* Lighter Indigo */
        }
        .section-title {
            border-bottom: 1px solid #4b5563; /* Gray-600 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #9ca3af; /* Gray-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .detail-item {
            margin-bottom: 0.75rem;
        }
        .detail-item strong {
            color: #e5e7eb; /* Gray-200 */
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000; /* Ensure it's above other content */
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.error {
            background-color: #ef4444; /* Red-500 */
        }
         .notification.success {
            background-color: #22c55e; /* Green-500 */
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes shine {
            0% {
                background-position: -200%;
            }
            100% {
                background-position: 200%;
            }
        }

        .shining-text {
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0.2) 100%);
            background-size: 200%;
            animation: shine 2s infinite;
        }
    </style>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "rgxl0spdx0");
    </script>
    <script>
        async function fetchCandidates() {
            try {
                const response = await fetch('candidates.json');
                if (!response.ok) throw new Error('Failed to fetch candidates data');
                return await response.json();
            } catch (error) {
                console.error('Error fetching candidates:', error);
                return [];
            }
        }
    </script>
</head>
<body class="min-h-screen">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-red-500 to-yellow-500 shining-text">
                Philippine Senatorial Candidates
            </h1>
            <p class="text-lg text-gray-400 mt-2">May 2025 National Elections</p>
            <p class="text-sm text-gray-500 mt-1">Click on a candidate to view details. You can select up to 12 preferred senators.</p>
        </header>

        <div id="apiKeySection" class="mb-6 p-4 bg-gray-800 rounded-lg shadow">
            <div class="flex items-center mb-3">
                <label for="aiSearchToggle" class="text-sm font-medium text-gray-300 mr-3">Enable AI Search:</label>
                <input type="checkbox" id="aiSearchToggle" class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                <span id="aiSearchInfo" class="ml-2 text-xs text-gray-400">
                    Uses Google Gemini 1.5 Flash. Free tier usage may apply.
                    <a href="https://ai.google.dev/pricing" target="_blank" class="text-indigo-400 hover:underline">Billing Info</a>.
                </span>
            </div>

            <div id="apiKeyControlsContainer" class="hidden">
                <p id="apiKeyStatusMessage" class="text-sm text-gray-400 mb-2"></p>
                <div id="apiKeyInputGroup" class="flex flex-col sm:flex-row items-center gap-2 mb-2">
                    <label for="geminiApiKeyInput" class="text-sm font-medium text-gray-300 whitespace-nowrap sr-only sm:not-sr-only">Gemini API Key:</label>
                    <input type="text" id="geminiApiKeyInput" placeholder="Enter your Gemini API Key" class="search-input flex-grow pl-3 pr-3 py-2 rounded-lg border focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="saveApiKeyButton" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg text-sm w-full sm:w-auto">Save Key</button>
                </div>
                <button id="editApiKeyButton" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm hidden mb-2">Edit API Key</button>
                <p class="text-xs text-gray-500">
                    Your API key is stored in session storage for this browser session only.
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Get a free API key here</a>.
                </p>
            </div>
            <p id="apiKeyPromptMessage" class="text-sm text-gray-400 mt-2">Enable AI Search for advanced search capabilities using Google Gemini.</p>
        </div>


        <div class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex space-x-2 border border-gray-700 rounded-lg p-1 bg-gray-800">
                <button id="allCandidatesTab" class="tab-button active px-4 py-2 rounded-md text-sm font-medium">All Candidates</button>
                <button id="mySenatorsTab" class="tab-button px-4 py-2 rounded-md text-sm font-medium">My Senators (<span id="selectedCount">0</span>/12)</button>
            </div>
            <div class="relative w-full sm:w-1/2">
                <input type="text" id="searchInput" placeholder="Search candidates..." class="search-input w-full pl-10 pr-4 py-2 rounded-lg border focus:ring-indigo-500 focus:border-indigo-500">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        </div>

        <div id="candidateGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            </div>
        <p id="noResultsMessage" class="text-center text-gray-400 mt-10 text-xl hidden">No candidates found.</p>
        <p id="noSelectionsMessage" class="text-center text-gray-400 mt-10 text-xl hidden">You have not selected any preferred senators yet.</p>

    </div>

    <div id="candidateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-3xl rounded-lg shadow-xl p-6 md:p-8">
            <div class="flex justify-between items-start mb-6">
                <h2 id="modalCandidateNameTitle" class="text-3xl font-bold text-white">Candidate Name</h2>
                <button id="closeModalButton" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="md:flex md:space-x-6">
                <div class="md:w-1/3 text-center md:text-left mb-6 md:mb-0">
                    <img id="modalCandidatePhoto" src="" alt="Candidate Photo" class="w-48 h-48 object-cover rounded-lg mx-auto md:mx-0 mb-4 border-2 border-gray-600">
                    <h3 id="modalCandidateParty" class="text-indigo-400"></h3>
                    <p id="modalCandidateAge" class="text-sm text-gray-400"></p>
                    <p id="modalCandidateResidence" class="text-sm text-gray-400"></p>
                    <button id="modalSelectButton" class="w-full action-button text-white font-semibold py-3 px-4 rounded-lg mt-4">
                        Add to My Senators
                    </button>
                    <a id="modalProfileLink" href="#" target="_blank" class="w-full block text-center action-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg mt-4">
                        View Profile
                    </a>
                    <div class="flex justify-between mt-4">
                        <button id="prevCandidateButton" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                            Previous
                        </button>
                        <button id="nextCandidateButton" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                            Next
                        </button>
                    </div>
                </div>

                <div class="md:w-2/3">
                    <div class="mb-6">
                        <h4 class="section-title">Education</h4>
                        <ul id="modalEducation" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Job Affiliations</h4>
                        <ul id="modalJobAffiliations" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Government Experience</h4>
                        <ul id="modalGovtExperience" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Platforms</h4>
                        <ul id="modalPlatforms" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">In Favor Of</h4>
                        <ul id="modalInFavor" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Against</h4>
                        <ul id="modalAgainst" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Family Members in Politics</h4>
                        <ul id="modalFamilyMembers" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="section-title">Laws Passed</h4>
                        <ul id="modalLawsPassed" class="list-disc list-inside text-sm space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Candidate Data (Embed for simplicity, ideally from a JSON file)
        let candidatesData = [];

        const candidateGrid = document.getElementById('candidateGrid');
        const searchInput = document.getElementById('searchInput');
        const selectedCountDisplay = document.getElementById('selectedCount');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noSelectionsMessage = document.getElementById('noSelectionsMessage');

        const modal = document.getElementById('candidateModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalCandidateNameTitle = document.getElementById('modalCandidateNameTitle');
        const modalCandidatePhoto = document.getElementById('modalCandidatePhoto');
        const modalCandidateName = document.getElementById('modalCandidateName');
        const modalCandidateParty = document.getElementById('modalCandidateParty');
        const modalShortBio = document.getElementById('modalShortBio');
        const modalEducation = document.getElementById('modalEducation');
        const modalWorkBackground = document.getElementById('modalWorkBackground');
        const modalLawsAuthored = document.getElementById('modalLawsAuthored');
        const modalContributions = document.getElementById('modalContributions');
        const modalIssuesOrViolations = document.getElementById('modalIssuesOrViolations');
        const modalOtherKeyAspectsContainer = document.getElementById('modalOtherKeyAspectsContainer');
        const modalOtherKeyAspects = document.getElementById('modalOtherKeyAspects');
        const modalSelectButton = document.getElementById('modalSelectButton');

        const allCandidatesTab = document.getElementById('allCandidatesTab');
        const mySenatorsTab = document.getElementById('mySenatorsTab');

        // API Key and AI Search Toggle Elements
        const aiSearchToggle = document.getElementById('aiSearchToggle');
        const aiSearchInfo = document.getElementById('aiSearchInfo');
        const apiKeyControlsContainer = document.getElementById('apiKeyControlsContainer');
        const apiKeyStatusMessage = document.getElementById('apiKeyStatusMessage');
        const apiKeyInputGroup = document.getElementById('apiKeyInputGroup');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton'); // Already declared, but good to group
        const editApiKeyButton = document.getElementById('editApiKeyButton');
        const apiKeyPromptMessage = document.getElementById('apiKeyPromptMessage');

        let selectedSenators = JSON.parse(localStorage.getItem('selectedSenators')) || [];
        let currentFilter = 'all'; // 'all' or 'selected'
        let currentCandidateIdInModal = null;
        let geminiApiKey = sessionStorage.getItem('geminiApiKey');
        let currentNavigationList = []; // Holds the list for modal navigation and tab count reference
        let aiSearchEnabled = JSON.parse(sessionStorage.getItem('aiSearchEnabled')) || false;
        let searchDebounceTimer;

        const defaultSearchPlaceholder = "Search candidates...";
        const aiSearchPlaceholder = "e.g., who supports death penalty?";

        const spinnerSVG = `<svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
</svg>`;
        const searchIconSVG = `<svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
</svg>`;


        // Function to show non-blocking notifications
        function showNotification(message, type = 'error', duration = 3000) {
            const notificationArea = document.body; // Or a dedicated notification container
            const notification = document.createElement('div');
            notification.className = `notification ${type}`; // 'error' or 'success'
            notification.textContent = message;
            
            notificationArea.appendChild(notification);

            // Trigger the animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); // Small delay to allow CSS transition

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300); // Allow fade out animation to complete
            }, duration);
        }

        function saveApiKey() {
            const apiKeyInputValue = geminiApiKeyInput.value.trim();
            if (apiKeyInputValue) {
                geminiApiKey = apiKeyInputValue;
                sessionStorage.setItem('geminiApiKey', geminiApiKey);
                showNotification('Gemini API Key saved for this session.', 'success');
                updateApiKeySectionVisibility();
                geminiApiKeyInput.value = ''; // Clear the input field
            } else {
                showNotification('Please enter a valid Gemini API Key.', 'error');
            }
        }

        function updateApiKeySectionVisibility() {
            if (aiSearchEnabled) {
                apiKeyControlsContainer.classList.remove('hidden');
                apiKeyPromptMessage.classList.add('hidden');
                searchInput.placeholder = aiSearchPlaceholder;

                if (geminiApiKey) {
                    apiKeyStatusMessage.textContent = 'Gemini API Key is active.';
                    apiKeyInputGroup.classList.add('hidden');
                    editApiKeyButton.classList.remove('hidden');
                    if (geminiApiKeyInput) geminiApiKeyInput.value = ''; // Clear password field
                } else {
                    apiKeyStatusMessage.textContent = 'AI Search enabled. Please enter your Gemini API Key below.';
                    apiKeyInputGroup.classList.remove('hidden');
                    editApiKeyButton.classList.add('hidden');
                }
            } else {
                apiKeyControlsContainer.classList.add('hidden');
                apiKeyPromptMessage.classList.remove('hidden');
                searchInput.placeholder = defaultSearchPlaceholder;
                apiKeyStatusMessage.textContent = '';
            }
        }


        function updateSelectedCount() {
            selectedCountDisplay.textContent = selectedSenators.length;
            if (currentCandidateIdInModal !== null) {
                const isSelected = selectedSenators.includes(currentCandidateIdInModal);
                modalSelectButton.textContent = isSelected ? 'Remove from My Senators' : 'Add to My Senators';
                modalSelectButton.classList.toggle('bg-red-600', isSelected);
                modalSelectButton.classList.toggle('hover:bg-red-700', isSelected);
                modalSelectButton.classList.toggle('bg-indigo-600', !isSelected);
                modalSelectButton.classList.toggle('hover:bg-indigo-700', !isSelected);
            }
        }

        function saveSelectedSenators() {
            localStorage.setItem('selectedSenators', JSON.stringify(selectedSenators));
        }

        async function searchWithGemini(query, candidates) {
            if (!geminiApiKey) {
                showNotification('Gemini API Key not set for AI Search. Using local search.', 'error');
                // Fallback to local search
                return candidates.filter(candidate =>
                    candidate.name.toLowerCase().includes(query.toLowerCase()) ||
                    candidate.political_party.toLowerCase().includes(query.toLowerCase())
                );
            }

            const searchIconContainer = searchInput.parentElement.querySelector('.absolute.inset-y-0.left-0.pl-3.flex.items-center');
            const originalIconHTML = searchIconContainer ? searchIconContainer.innerHTML : searchIconSVG;
            if (searchIconContainer) searchIconContainer.innerHTML = spinnerSVG;

            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

            const simplifiedCandidates = candidates;

            const prompt = `
                You are an AI assistant helping to find Philippine senatorial candidates based on a user's query.
                Use your comprehensive understanding of diverse topics, including current events and public figures (drawing from your knowledge base which includes web information), to interpret the user's query effectively.
                I will provide you with a list of candidates and their details (name, political party, some platforms, stances).
                Your primary task is to identify which candidates *from this specific list* best match the user's query.
                Return a JSON array of "candidate_number" (which is an integer) for the matching candidates from the provided list.
                If no candidates match, return an empty JSON array: [].
                Only return candidate_numbers from the provided list. Do not invent new numbers or information not present in the candidate details.
                Do not include any explanations, apologies, or introductory text. Your entire response must be only the JSON array of numbers.
                For example, if candidates with numbers 3, 7, and 12 match, your response should be exactly: [3, 7, 12]

                Candidate List:
                ${JSON.stringify(simplifiedCandidates)}

                User Query: "${query}"

                Matching candidate_numbers (JSON array of integers):
            `;

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.2 } // Lower temperature for more factual/deterministic output
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    showNotification(`Gemini API Error: ${errorData.error?.message || response.statusText}`, 'error');
                    return [];
                }

                const data = await response.json();
                let resultText = '';

                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    resultText = data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    showNotification(`Gemini content blocked: ${data.promptFeedback.blockReason?.reason || data.promptFeedback.blockReason}`, 'error');
                    console.error('Gemini API Blocked:', data.promptFeedback);
                    return [];
                } else {
                    console.error('Unexpected Gemini API response structure:', data);
                    showNotification('Error parsing Gemini response. Check console.', 'error');
                    return [];
                }

                resultText = resultText.replace(/^```json\s*|```\s*$/g, '').trim();
                let matchingCandidateNumbers;
                try {
                    matchingCandidateNumbers = JSON.parse(resultText);
                    if (!Array.isArray(matchingCandidateNumbers) || !matchingCandidateNumbers.every(num => typeof num === 'number')) {
                        console.error('Gemini API did not return a valid JSON array of numbers:', resultText);
                        showNotification('AI search returned an unexpected format.', 'error');
                        return [];
                    }
                } catch (e) {
                    console.error('Error parsing JSON from Gemini:', e, "Raw response:", resultText);
                    showNotification('Error processing AI search results.', 'error');
                    return [];
                }
                return candidates.filter(c => matchingCandidateNumbers.includes(c.candidate_number));
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                showNotification('Failed to connect to AI search service.', 'error');
                return [];
            } finally {
                if (searchIconContainer) searchIconContainer.innerHTML = originalIconHTML;
            }
        }

        // Function to specifically update the "All Candidates" tab label
        function updateAllCandidatesTabLabel(count) {
            allCandidatesTab.innerHTML = `All Candidates (${count})`;
        }

        function renderCandidatesFromList(listToRender, searchTerm = '', currentTab = 'all') {
            candidateGrid.innerHTML = '';
            noResultsMessage.classList.add('hidden');
            noSelectionsMessage.classList.add('hidden');

            const candidatesToDisplay = listToRender;

            currentNavigationList = candidatesToDisplay; // Update the list for modal navigation

            if (candidatesToDisplay.length === 0) {
                if (searchTerm) {
                    noResultsMessage.classList.remove('hidden');
                } else if (currentTab === 'selected') {
                    noSelectionsMessage.classList.remove('hidden');
                }
                 // If 'all' tab and empty, initial load message should handle it.
                return;
            }

             candidatesToDisplay.forEach(candidate => {
                const card = document.createElement('div');
                card.className = `candidate-card fade-in relative group bg-gray-800 rounded-lg shadow-lg p-5 cursor-pointer flex flex-col items-center text-center ${selectedSenators.includes(candidate.candidate_number) ? 'selected' : ''}`;
                card.dataset.id = candidate.candidate_number;

                const image = document.createElement('img');
                image.src = './img/' + candidate.photo;
                image.alt = candidate.name;
                image.className = 'w-32 h-32 object-cover rounded-full mb-4 border-2 border-gray-700';

                const name = document.createElement('h3');
                name.className = 'text-xl font-semibold text-white mb-1';
                name.textContent = candidate.name;

                const party = document.createElement('p');
                party.className = 'text-sm text-indigo-400';
                party.textContent = candidate.political_party;

                // Add/Remove Button
                const addButton = document.createElement('button');
                addButton.className = 'absolute top-3 right-3 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-all duration-200 z-10';
                addButton.setAttribute('aria-label', 'Add or remove candidate');

                const updateAddButtonState = () => {
                    if (selectedSenators.includes(candidate.candidate_number)) {
                        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`; // Check icon
                        addButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        addButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    } else {
                        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`; // Plus icon
                        addButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                        addButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }
                };
                updateAddButtonState();

                addButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent card click (modal opening)
                    const candidateId = candidate.candidate_number;
                    const index = selectedSenators.indexOf(candidateId);

                    if (index > -1) {
                        selectedSenators.splice(index, 1);
                        showNotification(`${candidate.name} removed from your senators.`, 'success');
                    } else {
                        if (selectedSenators.length < 12) {
                            selectedSenators.push(candidateId);
                            showNotification(`${candidate.name} added to your senators.`, 'success');
                        } else {
                            showNotification('You can only select up to 12 senators.', 'error');
                            return;
                        }
                    }

                    saveSelectedSenators();
                    updateSelectedCount();
                    updateAddButtonState();
                    card.classList.toggle('selected', selectedSenators.includes(candidateId));

                    if (currentFilter === 'selected' && index > -1) {
                        // Re-render "My Senators" tab if an item was removed
                        performSearchAndRender(searchInput.value.trim(), 'selected');
                    }

                });

                // Add candidate number overlay
                const candidateNumberOverlay = document.createElement('div');
                candidateNumberOverlay.className = 'absolute bottom-2 left-2 text-gray-100 text-xs font-semibold bg-gray-700 bg-opacity-75 rounded-md px-2 py-1';
                candidateNumberOverlay.textContent = `#${candidate.candidate_number}`;

                card.appendChild(image);
                card.appendChild(name);
                card.appendChild(party);
                card.appendChild(addButton); // Ensure the add button is appended to the card
                card.appendChild(candidateNumberOverlay);

                card.addEventListener('click', () => openModal(candidate.candidate_number));
                candidateGrid.appendChild(card);
            });
        }

        async function performSearchAndRender(searchTerm, tab) {
            searchTerm = searchTerm.trim();
            let listForCurrentTabDisplay;
            let countForAllCandidatesTab;

            if (searchTerm) {
                if (aiSearchEnabled) {
                    candidateGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full py-10">
                        <span class="inline-block align-middle">${spinnerSVG}</span>
                        <span class="inline-block align-middle ml-2">AI is searching for "${searchTerm}"...</span>
                    </p>`;
                    // Perform AI search on all candidates to get the count for "All Candidates" tab
                    const allCandidatesMatchingAI = await searchWithGemini(searchTerm, candidatesData);
                    countForAllCandidatesTab = allCandidatesMatchingAI.length;

                    if (tab === 'all') {
                        listForCurrentTabDisplay = allCandidatesMatchingAI;
                    } else { // tab is 'selected', filter the AI results further
                        listForCurrentTabDisplay = allCandidatesMatchingAI.filter(c => selectedSenators.includes(c.candidate_number));
                    }
                } else { // Local search
                    const termLower = searchTerm.toLowerCase();
                    const allCandidatesMatchingLocal = candidatesData.filter(candidate =>
                        candidate.name.toLowerCase().includes(termLower) ||
                        candidate.political_party.toLowerCase().includes(termLower)
                    );
                    countForAllCandidatesTab = allCandidatesMatchingLocal.length;

                    if (tab === 'all') {
                        listForCurrentTabDisplay = allCandidatesMatchingLocal;
                    } else { // tab is 'selected'
                        const selectedBaseList = candidatesData.filter(c => selectedSenators.includes(c.candidate_number));
                        listForCurrentTabDisplay = selectedBaseList.filter(candidate => // Filter within selected
                            candidate.name.toLowerCase().includes(termLower) ||
                            candidate.political_party.toLowerCase().includes(termLower)
                        );
                    }
                }
                updateAllCandidatesTabLabel(countForAllCandidatesTab);
                renderCandidatesFromList(listForCurrentTabDisplay, searchTerm, tab);
            } else { // No search term
                updateAllCandidatesTabLabel(candidatesData.length);
                const baseList = (tab === 'all') ? candidatesData : candidatesData.filter(c => selectedSenators.includes(c.candidate_number));
                renderCandidatesFromList(baseList, '', tab);
            }
        }

        function populateModal(candidate) {
            currentCandidateIdInModal = candidate.candidate_number;
            modalCandidateNameTitle.textContent = candidate.name;
            modalCandidatePhoto.src = './img/' + candidate.photo || 'https://placehold.co/300x300/E0E0E0/757575?text=No+Image';
            modalCandidatePhoto.alt = candidate.name;
            modalCandidateParty.textContent = candidate.political_party;
            modalCandidateAge.textContent = `Age: ${candidate.basic_information.age}`;
            modalCandidateResidence.textContent = `Residence: ${candidate.basic_information.residence}`;

            const profileLink = candidate.profile_link || '#';
            const modalProfileLink = document.getElementById('modalProfileLink');
            modalProfileLink.href = profileLink;
            modalProfileLink.classList.toggle('hidden', profileLink === '#');

            const populateList = (element, items, formatter) => {
                element.innerHTML = '';
                if (items && items.length > 0) {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = formatter(item);
                        element.appendChild(li);
                    });
                } else {
                    element.innerHTML = '<li>No information available.</li>';
                }
            };

            populateList(modalEducation, candidate.education, item => `<strong>${item.degree}</strong> - ${item.institution}`);
            populateList(modalJobAffiliations, candidate.job_affiliations, item => item);
            populateList(modalGovtExperience, candidate.govt_experience, item => item);
            populateList(modalPlatforms, candidate.platforms, item => item);
            populateList(modalInFavor, candidate.in_favor, item => item);
            populateList(modalAgainst, candidate.against, item => item);
            populateList(modalFamilyMembers, candidate.family_members_in_politics, item => `<strong>${item.name}</strong> (${item.relation}) - ${item.position}`);
            populateList(modalLawsPassed, candidate.laws_passed, item => item);

            updateSelectedCount();

            // Show/hide prev/next buttons based on the current navigation list
            const prevButton = document.getElementById('prevCandidateButton');
            const nextButton = document.getElementById('nextCandidateButton');
            if (currentNavigationList.length <= 1) {
                prevButton.classList.add('hidden');
                nextButton.classList.add('hidden');
            } else {
                prevButton.classList.remove('hidden');
                nextButton.classList.remove('hidden');
            }
        }

        function openModal(candidateNumber) {
            const candidate = candidatesData.find(c => c.candidate_number === candidateNumber); // Match by candidate_number
            if (candidate) {
                populateModal(candidate);
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            currentCandidateIdInModal = null;
            document.body.style.overflow = 'auto';
        }

        function navigateCandidate(direction) {
            if (!currentCandidateIdInModal) return;
            const currentIndex = currentNavigationList.findIndex(c => c.candidate_number === currentCandidateIdInModal);
            if (currentIndex === -1) return;

            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = currentNavigationList.length - 1; // Wrap to last candidate
            if (newIndex >= currentNavigationList.length) newIndex = 0; // Wrap to first candidate

            openModal(currentNavigationList[newIndex].candidate_number);
        }

        // Add swipe functionality
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) navigateCandidate(1); // Swipe left for next
            if (touchEndX > touchStartX + 50) navigateCandidate(-1); // Swipe right for previous
        }

        modal.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        modal.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        // Event Listeners for navigation buttons
        document.getElementById('prevCandidateButton').addEventListener('click', () => navigateCandidate(-1));
        document.getElementById('nextCandidateButton').addEventListener('click', () => navigateCandidate(1));

        // Event Listeners
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(async () => {
                const searchTerm = e.target.value.trim();
                performSearchAndRender(searchTerm, currentFilter);
            }, 1500);
        });
        closeModalButton.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        modalSelectButton.addEventListener('click', () => {
            if (currentCandidateIdInModal === null) return;

            const candidateId = currentCandidateIdInModal;
            const candidate = candidatesData.find(c => c.candidate_number === candidateId); // Match by candidate_number
            if (!candidate) return;

            const index = selectedSenators.indexOf(candidateId);

            if (index > -1) {
                // Remove from My Senators
                selectedSenators.splice(index, 1);
                showNotification(`${candidate.name} removed from your senators.`, 'success');
            } else {
                // Add to My Senators if limit is not exceeded
                if (selectedSenators.length < 12) {
                    selectedSenators.push(candidateId);
                    showNotification(`${candidate.name} added to your senators.`, 'success');
                } else {
                    showNotification('You can only select up to 12 senators.', 'error');
                    return;
                }
            }

            saveSelectedSenators();
            updateSelectedCount(); // Update modal button and count display

            // Update the corresponding card in the grid
            const cardInGrid = candidateGrid.querySelector(`.candidate-card[data-id='${candidateId}']`);
            if (cardInGrid) {
                cardInGrid.classList.toggle('selected', selectedSenators.includes(candidateId));
            }

            // If on "My Senators" tab and a senator is removed, re-render
            if (currentFilter === 'selected' && index > -1) {
                performSearchAndRender(searchInput.value, 'selected');
            }
        });

        allCandidatesTab.addEventListener('click', () => {
            currentFilter = 'all';
            allCandidatesTab.classList.add('active');
            mySenatorsTab.classList.remove('active');
            performSearchAndRender(searchInput.value, 'all');
        });

        mySenatorsTab.addEventListener('click', () => {
            currentFilter = 'selected';
            mySenatorsTab.classList.add('active');
            allCandidatesTab.classList.remove('active');
            performSearchAndRender(searchInput.value, 'selected');
        });

        async function initializeCandidates() {
            candidatesData = await fetchCandidates();
            if (candidatesData.length === 0) {
                candidateGrid.innerHTML = '<p class="text-center text-gray-400 mt-10 text-xl col-span-full">Failed to load candidate data or no data available.</p>';
                noResultsMessage.classList.add('hidden');
                updateAllCandidatesTabLabel(0);
                mySenatorsTab.classList.remove('active'); // Ensure 'All' tab seems primary
                allCandidatesTab.classList.add('active');
                return;
            }
            // Sort candidates by candidate_number
            candidatesData.sort((a, b) => a.candidate_number - b.candidate_number);
            currentNavigationList = [...candidatesData]; // Initialize navigation list
            updateAllCandidatesTabLabel(candidatesData.length); // Initial count for "All Candidates" tab
            updateSelectedCount(); // Initial count for "My Senators" tab
            performSearchAndRender('', currentFilter); // Initial render
        }

        document.addEventListener('DOMContentLoaded', () => {
            aiSearchToggle.checked = aiSearchEnabled;
            // Set initial placeholder based on aiSearchEnabled state
            updateApiKeySectionVisibility();

            saveApiKeyButton.addEventListener('click', saveApiKey);

            editApiKeyButton.addEventListener('click', () => {
                apiKeyInputGroup.classList.remove('hidden');
                editApiKeyButton.classList.add('hidden');
                apiKeyStatusMessage.textContent = 'Update your Gemini API Key.';
                if (geminiApiKeyInput) geminiApiKeyInput.focus();
            });

            aiSearchToggle.addEventListener('change', () => {
                aiSearchEnabled = aiSearchToggle.checked;
                sessionStorage.setItem('aiSearchEnabled', JSON.stringify(aiSearchEnabled));
                updateApiKeySectionVisibility();
                performSearchAndRender(searchInput.value, currentFilter); // Re-filter/render

                if (aiSearchEnabled && !geminiApiKey) {
                    showNotification('AI Search enabled. Please provide your Gemini API Key to use this feature.', 'error', 4000);
                }
            });

            initializeCandidates();
        });
    </script>
    <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-10">
        <p class="text-sm">
            AI Search powered by Google Gemini. Results depend on the model's interpretation of the query and provided data.
        </p>
        <p class="text-sm mt-2">
            Disclaimer: The data in this project is for informational purposes only and is based on publicly available information. While efforts were made to ensure accuracy, there may be discrepancies due to the nature of manual scraping, AI processing, and the dynamic nature of election-related data. Users are encouraged to verify the information from official sources.
        </p>
        <p class="text-sm mt-4">
            All data is stored locally on your device and is not processed by any external servers or applications.
        </p>
        <p class="text-sm mt-4">
            Sources: 
            <a href="https://www.facebook.com/philstarnews" target="_blank" class="text-indigo-400 hover:underline">PhilStar</a>, 
            <a href="https://www.facebook.com/NUDNUntium" target="_blank" class="text-indigo-400 hover:underline">The NUntium</a>, 
            <a href="https://www.facebook.com/sscalangilan" target="_blank" class="text-indigo-400 hover:underline">Supreme Student Council - BatStateU Alangilan Campus</a>.
        </p>
        <p class="text-sm mt-4">
            Visit the project repository: 
            <a href="https://github.com/kfasides/ph-election-2025" target="_blank" class="text-indigo-400 hover:underline">GitHub Repository</a>.
        </p>
    </footer>
</body>
</html>
